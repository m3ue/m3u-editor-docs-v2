/**
 * Docker Compose Template Generator
 *
 * Generates docker-compose.yml content based on wizard configuration.
 */

// Helper to format environment variables
const formatEnvVar = (name, value) => {
  if (value === '' || value === null || value === undefined) return null;
  if (typeof value === 'boolean') return `      - ${name}=${value}`;
  return `      - ${name}=${value}`;
};

// Helper to add conditional env vars
const addEnvVar = (envVars, name, value, condition = true) => {
  if (condition && value !== '' && value !== null && value !== undefined) {
    envVars.push(formatEnvVar(name, value));
  }
};

// Generate environment section for m3u-editor
const generateEditorEnv = (config) => {
  const envVars = [];

  // Application settings
  addEnvVar(envVars, 'APP_URL', config.APP_URL);
  addEnvVar(envVars, 'APP_PORT', config.APP_PORT);
  addEnvVar(envVars, 'TZ', config.TZ);
  addEnvVar(envVars, 'APP_DEBUG', config.APP_DEBUG, config.APP_DEBUG);

  // Database settings
  addEnvVar(envVars, 'DB_CONNECTION', config.DB_CONNECTION);
  if (config.DB_CONNECTION === 'pgsql') {
    addEnvVar(envVars, 'ENABLE_POSTGRES', config.ENABLE_POSTGRES, config.ENABLE_POSTGRES);
    addEnvVar(envVars, 'PG_DATABASE', config.PG_DATABASE);
    addEnvVar(envVars, 'PG_USER', config.PG_USER);
    addEnvVar(envVars, 'PG_PASSWORD', config.PG_PASSWORD);
    addEnvVar(envVars, 'DB_HOST', config.DB_HOST);
    addEnvVar(envVars, 'DB_PORT', config.DB_PORT);
  }

  // Proxy settings (for modular/vpn deployments)
  if (config.M3U_PROXY_ENABLED !== undefined) {
    const proxyEnabled = config.M3U_PROXY_ENABLED === 'embedded';
    addEnvVar(envVars, 'M3U_PROXY_ENABLED', proxyEnabled);
    addEnvVar(envVars, 'M3U_PROXY_PORT', config.M3U_PROXY_PORT);
    addEnvVar(envVars, 'M3U_PROXY_HOST', config.M3U_PROXY_HOST);
    addEnvVar(envVars, 'M3U_PROXY_TOKEN', config.M3U_PROXY_TOKEN);
    addEnvVar(envVars, 'M3U_PROXY_LOG_LEVEL', config.M3U_PROXY_LOG_LEVEL, config.M3U_PROXY_LOG_LEVEL);
  }

  // Redis settings
  if (config.REDIS_ENABLED !== undefined) {
    addEnvVar(envVars, 'REDIS_ENABLED', !config.REDIS_ENABLED ? false : undefined, !config.REDIS_ENABLED);
    addEnvVar(envVars, 'REDIS_HOST', config.REDIS_HOST, config.REDIS_ENABLED);
    addEnvVar(envVars, 'REDIS_SERVER_PORT', config.REDIS_SERVER_PORT, config.REDIS_ENABLED);
  }

  // Web server settings
  if (config.NGINX_ENABLED !== undefined) {
    addEnvVar(envVars, 'NGINX_ENABLED', config.NGINX_ENABLED, !config.NGINX_ENABLED);
    addEnvVar(envVars, 'FPMPORT', config.FPMPORT, !config.NGINX_ENABLED);
  }
  addEnvVar(envVars, 'XTREAM_ONLY_ENABLED', config.XTREAM_ONLY_ENABLED, config.XTREAM_ONLY_ENABLED);
  addEnvVar(envVars, 'XTREAM_PORT', config.XTREAM_PORT, config.XTREAM_ONLY_ENABLED);

  // WebSocket settings
  addEnvVar(envVars, 'REVERB_PORT', config.REVERB_PORT);
  addEnvVar(envVars, 'REVERB_VERIFY', config.REVERB_VERIFY, !config.REVERB_VERIFY);

  // Playlist settings
  addEnvVar(envVars, 'MAX_CHANNELS', config.MAX_CHANNELS, config.MAX_CHANNELS !== '50000');
  addEnvVar(envVars, 'DISABLE_SYNC_LOGS', config.DISABLE_SYNC_LOGS, config.DISABLE_SYNC_LOGS);
  addEnvVar(envVars, 'INVALIDATE_IMPORT', config.INVALIDATE_IMPORT, config.INVALIDATE_IMPORT);
  addEnvVar(envVars, 'INVALIDATE_IMPORT_THRESHOLD', config.INVALIDATE_IMPORT_THRESHOLD, config.INVALIDATE_IMPORT);

  // HLS settings
  addEnvVar(envVars, 'HLS_TEMP_DIR', config.HLS_TEMP_DIR, config.HLS_TEMP_DIR !== '/tmp/hls');
  addEnvVar(envVars, 'HLS_GC_ENABLED', config.HLS_GC_ENABLED, !config.HLS_GC_ENABLED);
  addEnvVar(envVars, 'HLS_GC_INTERVAL', config.HLS_GC_INTERVAL, config.HLS_GC_INTERVAL !== '60');
  addEnvVar(envVars, 'HLS_GC_AGE_THRESHOLD', config.HLS_GC_AGE_THRESHOLD, config.HLS_GC_AGE_THRESHOLD !== '300');

  // Auth settings
  addEnvVar(envVars, 'AUTO_LOGIN', config.AUTO_LOGIN, config.AUTO_LOGIN);
  addEnvVar(envVars, 'LOGIN_PATH', config.LOGIN_PATH, config.LOGIN_PATH !== 'login');
  addEnvVar(envVars, 'REDIRECT_GUEST_TO_LOGIN', config.REDIRECT_GUEST_TO_LOGIN, !config.REDIRECT_GUEST_TO_LOGIN);

  return envVars.filter(Boolean).join('\n');
};

// Generate volumes section
const generateVolumes = (config) => {
  const volumes = [];
  volumes.push(`      - ${config.CONFIG_PATH || './data'}:/config`);
  if (config.STRM_PATH) {
    volumes.push(`      - ${config.STRM_PATH}:/strm`);
  }
  return volumes.join('\n');
};

// Template generators for each deployment type
export const generateModularCompose = (config) => {
  const editorEnv = generateEditorEnv(config);
  const volumes = generateVolumes(config);

  return `# Docker Compose - Modular Deployment
# Generated by M3U Editor Compose Wizard
# https://m3u-editor.com/compose-wizard

services:
  m3u-editor:
    image: sparkison/m3u-editor:latest
    container_name: m3u-editor
    environment:
${editorEnv}
    volumes:
${volumes}
    ports:
      - "${config.APP_PORT}:${config.APP_PORT}"${config.XTREAM_ONLY_ENABLED ? `
      - "${config.XTREAM_PORT}:${config.XTREAM_PORT}"` : ''}
    restart: unless-stopped
    depends_on:
      - m3u-proxy
      - m3u-redis
    networks:
      - m3u-network

  m3u-proxy:
    image: sparkison/m3u-proxy:latest
    container_name: m3u-proxy
    environment:
      - API_TOKEN=\${M3U_PROXY_TOKEN:-${config.M3U_PROXY_TOKEN}}
      - REDIS_ADDR=m3u-redis:${config.REDIS_SERVER_PORT || '6379'}
      - LOG_LEVEL=${config.M3U_PROXY_LOG_LEVEL || 'INFO'}
    ports:
      - "${config.M3U_PROXY_PORT}:8085"
    restart: unless-stopped
    depends_on:
      - m3u-redis
    networks:
      - m3u-network

  m3u-redis:
    image: redis:alpine
    container_name: m3u-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - m3u-network

networks:
  m3u-network:
    driver: bridge

volumes:
  redis-data:
`;
};

export const generateAioCompose = (config) => {
  const editorEnv = generateEditorEnv(config);
  const volumes = generateVolumes(config);

  return `# Docker Compose - All-in-One Deployment
# Generated by M3U Editor Compose Wizard
# https://m3u-editor.com/compose-wizard
#
# Note: This configuration does NOT support hardware acceleration.
# For hardware acceleration, use the Modular deployment.

services:
  m3u-editor:
    image: sparkison/m3u-editor:latest
    container_name: m3u-editor
    environment:
${editorEnv}
    volumes:
${volumes}
    ports:
      - "${config.APP_PORT}:${config.APP_PORT}"${config.XTREAM_ONLY_ENABLED ? `
      - "${config.XTREAM_PORT}:${config.XTREAM_PORT}"` : ''}
    restart: unless-stopped
`;
};

export const generateVpnCompose = (config) => {
  const editorEnv = generateEditorEnv(config);
  const volumes = generateVolumes(config);

  // VPN-specific environment variables
  let vpnEnv = `      - VPN_SERVICE_PROVIDER=${config.VPN_SERVICE_PROVIDER}
      - VPN_TYPE=${config.VPN_TYPE}`;

  if (config.VPN_TYPE === 'openvpn') {
    if (config.OPENVPN_USER) vpnEnv += `\n      - OPENVPN_USER=${config.OPENVPN_USER}`;
    if (config.OPENVPN_PASSWORD) vpnEnv += `\n      - OPENVPN_PASSWORD=${config.OPENVPN_PASSWORD}`;
  } else if (config.VPN_TYPE === 'wireguard') {
    if (config.WIREGUARD_PRIVATE_KEY) vpnEnv += `\n      - WIREGUARD_PRIVATE_KEY=${config.WIREGUARD_PRIVATE_KEY}`;
  }

  if (config.SERVER_COUNTRIES) {
    vpnEnv += `\n      - SERVER_COUNTRIES=${config.SERVER_COUNTRIES}`;
  }

  return `# Docker Compose - VPN Deployment (Gluetun)
# Generated by M3U Editor Compose Wizard
# https://m3u-editor.com/compose-wizard
#
# IMPORTANT: Configure your VPN provider settings below.
# See https://github.com/qdm12/gluetun for provider-specific configuration.

services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
${vpnEnv}
    ports:
      - "${config.M3U_PROXY_PORT}:8085"  # m3u-proxy
    volumes:
      - gluetun-data:/gluetun
    restart: unless-stopped
    networks:
      - m3u-network

  m3u-editor:
    image: sparkison/m3u-editor:latest
    container_name: m3u-editor
    environment:
${editorEnv}
    volumes:
${volumes}
    ports:
      - "${config.APP_PORT}:${config.APP_PORT}"${config.XTREAM_ONLY_ENABLED ? `
      - "${config.XTREAM_PORT}:${config.XTREAM_PORT}"` : ''}
    restart: unless-stopped
    depends_on:
      - m3u-proxy
      - m3u-redis
    networks:
      - m3u-network

  m3u-proxy:
    image: sparkison/m3u-proxy:latest
    container_name: m3u-proxy
    network_mode: "service:gluetun"
    environment:
      - API_TOKEN=\${M3U_PROXY_TOKEN:-${config.M3U_PROXY_TOKEN}}
      - REDIS_ADDR=m3u-redis:${config.REDIS_SERVER_PORT || '6379'}
      - LOG_LEVEL=${config.M3U_PROXY_LOG_LEVEL || 'INFO'}
    restart: unless-stopped
    depends_on:
      - gluetun
      - m3u-redis

  m3u-redis:
    image: redis:alpine
    container_name: m3u-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - m3u-network

networks:
  m3u-network:
    driver: bridge

volumes:
  redis-data:
  gluetun-data:
`;
};

export const generateExternalNginxCompose = (config) => {
  const editorEnv = generateEditorEnv({ ...config, NGINX_ENABLED: false });
  const volumes = generateVolumes(config);

  return `# Docker Compose - External Nginx Deployment
# Generated by M3U Editor Compose Wizard
# https://m3u-editor.com/compose-wizard
#
# This configuration uses an external Nginx reverse proxy.
# See the Nginx configuration section below.

services:
  m3u-editor:
    image: sparkison/m3u-editor:latest
    container_name: m3u-editor
    environment:
${editorEnv}
      - NGINX_ENABLED=false
      - FPMPORT=${config.FPMPORT || '9000'}
    volumes:
${volumes}
    restart: unless-stopped
    depends_on:
      - m3u-proxy
      - m3u-redis
    networks:
      - m3u-network

  m3u-proxy:
    image: sparkison/m3u-proxy:latest
    container_name: m3u-proxy
    environment:
      - API_TOKEN=\${M3U_PROXY_TOKEN:-${config.M3U_PROXY_TOKEN}}
      - REDIS_ADDR=m3u-redis:${config.REDIS_SERVER_PORT || '6379'}
      - LOG_LEVEL=${config.M3U_PROXY_LOG_LEVEL || 'INFO'}
    restart: unless-stopped
    depends_on:
      - m3u-redis
    networks:
      - m3u-network

  m3u-redis:
    image: redis:alpine
    container_name: m3u-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - m3u-network

  nginx:
    image: nginx:alpine
    container_name: m3u-nginx
    ports:
      - "${config.APP_PORT}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ${config.CONFIG_PATH || './data'}:/var/www/html:ro
    restart: unless-stopped
    depends_on:
      - m3u-editor
    networks:
      - m3u-network

networks:
  m3u-network:
    driver: bridge

volumes:
  redis-data:

# -----------------------------------------------------------
# NGINX CONFIGURATION
# Save the following as nginx.conf in the same directory
# -----------------------------------------------------------
#
# worker_processes auto;
# events { worker_connections 1024; }
#
# http {
#     include /etc/nginx/mime.types;
#     default_type application/octet-stream;
#
#     upstream php-fpm {
#         server m3u-editor:${config.FPMPORT || '9000'};
#     }
#
#     server {
#         listen 80;
#         server_name _;
#         root /var/www/html/public;
#         index index.php;
#
#         location / {
#             try_files $uri $uri/ /index.php?$query_string;
#         }
#
#         location ~ \\.php$ {
#             fastcgi_pass php-fpm;
#             fastcgi_index index.php;
#             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#             include fastcgi_params;
#         }
#     }
# }
`;
};

export const generateExternalCaddyCompose = (config) => {
  const editorEnv = generateEditorEnv({ ...config, NGINX_ENABLED: false });
  const volumes = generateVolumes(config);

  // Extract domain from APP_URL
  const domain = config.APP_URL?.replace(/^https?:\/\//, '').replace(/\/$/, '') || 'localhost';

  return `# Docker Compose - External Caddy Deployment
# Generated by M3U Editor Compose Wizard
# https://m3u-editor.com/compose-wizard
#
# This configuration uses Caddy reverse proxy with automatic HTTPS.

services:
  m3u-editor:
    image: sparkison/m3u-editor:latest
    container_name: m3u-editor
    environment:
${editorEnv}
      - NGINX_ENABLED=false
      - FPMPORT=${config.FPMPORT || '9000'}
    volumes:
${volumes}
    restart: unless-stopped
    depends_on:
      - m3u-proxy
      - m3u-redis
    networks:
      - m3u-network

  m3u-proxy:
    image: sparkison/m3u-proxy:latest
    container_name: m3u-proxy
    environment:
      - API_TOKEN=\${M3U_PROXY_TOKEN:-${config.M3U_PROXY_TOKEN}}
      - REDIS_ADDR=m3u-redis:${config.REDIS_SERVER_PORT || '6379'}
      - LOG_LEVEL=${config.M3U_PROXY_LOG_LEVEL || 'INFO'}
    restart: unless-stopped
    depends_on:
      - m3u-redis
    networks:
      - m3u-network

  m3u-redis:
    image: redis:alpine
    container_name: m3u-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - m3u-network

  caddy:
    image: caddy:alpine
    container_name: m3u-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - ${config.CONFIG_PATH || './data'}:/var/www/html:ro
    restart: unless-stopped
    depends_on:
      - m3u-editor
    networks:
      - m3u-network

networks:
  m3u-network:
    driver: bridge

volumes:
  redis-data:
  caddy-data:
  caddy-config:

# -----------------------------------------------------------
# CADDYFILE CONFIGURATION
# Save the following as Caddyfile in the same directory
# -----------------------------------------------------------
#
# ${domain} {
#     root * /var/www/html/public
#     php_fastcgi m3u-editor:${config.FPMPORT || '9000'}
#     file_server
#     encode gzip
#
#     @proxy path /proxy/*
#     reverse_proxy @proxy m3u-proxy:8085
# }
`;
};

// Main generator function
export const generateComposeFile = (deploymentType, config) => {
  switch (deploymentType) {
    case 'modular':
      return generateModularCompose(config);
    case 'aio':
      return generateAioCompose(config);
    case 'vpn':
      return generateVpnCompose(config);
    case 'external-nginx':
      return generateExternalNginxCompose(config);
    case 'external-caddy':
      return generateExternalCaddyCompose(config);
    default:
      return generateModularCompose(config);
  }
};

// Generate .env file content
export const generateEnvFile = (config) => {
  const lines = [
    '# M3U Editor Environment Configuration',
    '# Generated by M3U Editor Compose Wizard',
    '',
  ];

  // Add token for docker-compose variable substitution
  if (config.M3U_PROXY_TOKEN) {
    lines.push(`M3U_PROXY_TOKEN=${config.M3U_PROXY_TOKEN}`);
  }
  if (config.PG_PASSWORD) {
    lines.push(`PG_PASSWORD=${config.PG_PASSWORD}`);
  }

  return lines.join('\n');
};
